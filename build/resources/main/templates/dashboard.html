<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>계좌 조회 & 카드 발급</title>
  <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; }
        h2 { color: #333; }
        label { display: block; margin-top: 12px; font-weight: bold; }
        input, select, button { padding: 8px; margin-top: 4px; }
        button { cursor: pointer; }
        .section { margin-bottom: 40px; }
        table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #eee; }
        .success { color: green; font-weight: bold; margin-bottom: 6px; }
        .error { color: red; font-weight: bold; margin-bottom: 6px; }
        .customer-table { margin-bottom: 24px; }
    </style>
</head>
<body>

<div class="section">
  <h2>고객 계좌 조회 (개설일 순)</h2>
  <label>고객 이름:</label>
  <input type="text" id="searchName" placeholder="홍길동">
  <button onclick="fetchAccounts()">조회</button>
  <div id="accountResult"></div>
</div>

<div class="section">
  <h2>카드 발급</h2>
  <form id="cardForm">
    <label>고객 SSN:</label>
    <input type="text" id="customerSsn" required>

    <label>고객 이름:</label>
    <input type="text" id="customerName" required>

    <label>연결 계좌 ID:</label>
    <input type="text" id="accountId" required>

    <label>카드 종류:</label>
    <select id="cardType">
      <option value="신용">신용카드</option>
      <option value="체크">체크카드</option>
    </select>

    <button type="button" onclick="issueCard()">카드 발급</button>
  </form>
  <div id="cardResult"></div>
</div>

<script>
async function fetchAccounts() {
    const name = document.getElementById("searchName").value.trim();
    if (!name) return alert("고객 이름을 입력하세요.");

    try {
        // 고객별 그룹핑된 계좌 조회
        const res = await fetch(`/account/by-name/grouped?customerName=${encodeURIComponent(name)}`);
        if (!res.ok) throw new Error("서버 오류 발생");
        const groupedAccounts = await res.json();

        const container = document.getElementById("accountResult");
        container.innerHTML = '';

        const customerKeys = Object.keys(groupedAccounts);
        if (customerKeys.length === 0) {
            container.innerHTML = `<div class="error">조회된 계좌가 없습니다.</div>`;
            return;
        }

        // 고객별로 테이블 생성
        customerKeys.forEach(ssn => {
            const accounts = groupedAccounts[ssn];
            const customerName = accounts[0]?.customerName || '';

            let html = `<div class="customer-table">
                <h3>고객: ${customerName} (SSN: ${ssn})</h3>
                <table>
                    <tr>
                        <th>계좌 ID</th>
                        <th>잔액</th>
                    </tr>`;

            accounts.forEach(a => {
                html += `<tr>
                    <td>${a.accountId}</td>
                    <td>${a.balance.toLocaleString()}원</td>
                </tr>`;
            });

            html += `</table></div>`;
            container.innerHTML += html;
        });

    } catch (err) {
        document.getElementById("accountResult").innerHTML = `<div class="error">오류: ${err.message}</div>`;
    }
}

async function issueCard() {
    const formData = new URLSearchParams();
    formData.append("customerSsn", document.getElementById("customerSsn").value);
    formData.append("customerName", document.getElementById("customerName").value);
    formData.append("accountId", document.getElementById("accountId").value);
    formData.append("cardType", document.getElementById("cardType").value);

    try {
        const res = await fetch("/bank/card/issue", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: formData.toString()
        });
        if (!res.ok) throw new Error("카드 발급 실패");
        const card = await res.json();

        document.getElementById("cardResult").innerHTML = `
            <div class="success">카드 발급 성공!</div>
            <table>
                <tr><th>카드 ID</th><td>${card.cardId}</td></tr>
                <tr><th>고객 이름</th><td>${card.customer.customerName}</td></tr>
                <tr><th>고객 SSN</th><td>${card.customer.customerSsn}</td></tr>
                <tr><th>연결 계좌 ID</th><td>${card.account.accountId}</td></tr>
                <tr><th>카드 종류</th><td>${card.cardType}</td></tr>
                <tr><th>발급일</th><td>${card.issueDate}</td></tr>
                <tr><th>한도</th><td>${card.limitAmount.toLocaleString()}원</td></tr>
                <tr><th>결제일</th><td>${card.paymentDate}</td></tr>
            </table>
        `;
    } catch (err) {
        document.getElementById("cardResult").innerHTML = `<div class="error">${err.message}</div>`;
    }
}
</script>
</body>
</html>
