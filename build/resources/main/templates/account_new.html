<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê³„ì¢Œ & ì¹´ë“œ ê´€ë¦¬</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; }
    h2 { color: #333; }
    label { display: block; margin-top: 12px; font-weight: bold; }
    input, select, button { padding: 8px; margin-top: 4px; }
    button { cursor: pointer; }
    .section { margin-bottom: 40px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #eee; }
    .success { color: green; font-weight: bold; margin-bottom: 6px; }
    .error { color: red; font-weight: bold; margin-bottom: 6px; }
  </style>
</head>
<body>

<div class="section">
  <h2>ìƒˆ ê³„ì¢Œ ë§Œë“¤ê¸°</h2>
  <form id="accountForm">
    <label>ê³ ê° ì´ë¦„ :</label>
    <input type="text" id="customerName" required>

    <label>ê³ ê° ì£¼ë¯¼ë²ˆí˜¸(SSN) :</label>
    <input type="text" id="customerSsn" required>

    <label>ê³„ì¢Œ ì¢…ë¥˜ :</label>
    <select id="accountType">
      <option value="ì ê¸ˆ">ì ê¸ˆ</option>
      <option value="ì…ì¶œê¸ˆ">ì…ì¶œê¸ˆ</option>
    </select><br><br>

    <button type="button" onclick="submitAccountForm()">ê³„ì¢Œ ìƒì„±</button>
  </form>
  <div id="accountResult"></div>
</div>

<hr>

<div class="section">
  <h2>ê³ ê° ê³„ì¢Œ ì¡°íšŒ</h2>
  <label>ê³ ê° ì´ë¦„:</label>
  <input type="text" id="searchName" placeholder="í™ê¸¸ë™">
  <button onclick="fetchAccounts()">ì¡°íšŒ</button>
  <div id="accountsTable"></div>
</div>

<hr>

<div class="section">
  <h2>ì¹´ë“œ ë°œê¸‰</h2>
  <form id="cardForm">
    <label>ê³ ê° SSN:</label>
    <input type="text" id="cardCustomerSsn" required>

    <label>ê³ ê° ì´ë¦„:</label>
    <input type="text" id="cardCustomerName" required>

    <label>ì—°ê²° ê³„ì¢Œ ID:</label>
    <input type="text" id="accountId" required>

    <label>ì¹´ë“œ ì¢…ë¥˜:</label>
    <select id="cardType">
      <option value="ì‹ ìš©">ì‹ ìš©ì¹´ë“œ</option>
      <option value="ì²´í¬">ì²´í¬ì¹´ë“œ</option>
    </select>

    <button type="button" onclick="issueCard()">ì¹´ë“œ ë°œê¸‰</button>
  </form>
  <div id="cardResult"></div>
</div>
<button id="btnNextBirthday">ê°€ì¥ ê°€ê¹Œìš´ ìƒì¼ ê³ ê° ì¡°íšŒ</button>

<div id="birthdayResult" style="margin-top:15px; font-size:18px; font-weight:bold;"></div>

<script>
function submitAccountForm() {
    const name = document.getElementById("customerName").value;
    const ssn = document.getElementById("customerSsn").value;
    const type = document.getElementById("accountType").value;

    fetch(`/account/create?customerSsn=${ssn}&customerName=${name}&accountType=${type}`, {
        method: "POST"
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("accountResult").innerHTML =
            `<div class="success">ê³„ì¢Œ ìƒì„± ì™„ë£Œ!</div>
             <p>ê³„ì¢Œ ID: ${data.accountId}</p>
             <p>ê³„ì¢Œ ì¢…ë¥˜: ${data.accountType}</p>
             <p>ê³ ê° ì´ë¦„: ${data.customer.customerName}</p>
             <p>ê³ ê° SSN: ${data.customer.customerSsn}</p>`;
    })
    .catch(err => { alert("ì˜¤ë¥˜ ë°œìƒ: " + err); });
}

async function fetchAccounts() {
    const name = document.getElementById("searchName").value.trim();
    if (!name) return alert("ê³ ê° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

    try {
        const res = await fetch(`/account/by-name/grouped?customerName=${encodeURIComponent(name)}`);
        if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
        const grouped = await res.json();

        let html = "";
        for (const ssn in grouped) {
            html += `<h3>ê³ ê° SSN: ${ssn} (${grouped[ssn][0].customerName})</h3>`;
            html += `<table>
                        <tr><th>ê³„ì¢Œ ID</th><th>ê³„ì¢Œ ì¢…ë¥˜</th><th>ì”ì•¡</th></tr>`;
            grouped[ssn].forEach(acc => {
                html += `<tr>
                            <td>${acc.accountId}</td>
                            <td>${acc.accountType}</td>
                            <td>${acc.balance.toLocaleString()}ì›</td>
                         </tr>`;
            });
            html += `</table><br>`;
        }
        document.getElementById("accountsTable").innerHTML = html;
    } catch(err) {
        document.getElementById("accountsTable").innerHTML = `<div class="error">ì˜¤ë¥˜: ${err.message}</div>`;
    }
}

function issueCard() {
    const formData = new URLSearchParams();
    formData.append("customerSsn", document.getElementById("cardCustomerSsn").value);
    formData.append("customerName", document.getElementById("cardCustomerName").value);
    formData.append("accountId", document.getElementById("accountId").value);
    formData.append("cardType", document.getElementById("cardType").value);

    fetch("/account/card/issue", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formData.toString()
    })
    .then(res => res.json())
    .then(card => {
        document.getElementById("cardResult").innerHTML =
            `<div class="success">ì¹´ë“œ ë°œê¸‰ ì„±ê³µ!</div>
             <p>ì¹´ë“œ ID: ${card.cardId}</p>
             <p>ê³ ê° ì´ë¦„: ${card.customer.customerName}</p>
             <p>ê³ ê° SSN: ${card.customer.customerSsn}</p>
             <p>ì—°ê²° ê³„ì¢Œ ID: ${card.account.accountId}</p>
             <p>ì¹´ë“œ ì¢…ë¥˜: ${card.cardType}</p>
             <p>ë°œê¸‰ì¼: ${card.issueDate}</p>`;
    })
    .catch(err => {
        document.getElementById("cardResult").innerHTML = `<div class="error">${err}</div>`;
    });
}

 document.getElementById("btnNextBirthday").addEventListener("click", function() {
        fetch("/account/next-birthday")
            .then(response => response.json())
            .then(data => {
                let resultArea = document.getElementById("birthdayResult");

                if(!data || !data.customerName) {
                    resultArea.innerHTML = "ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
                    return;
                }

                resultArea.innerHTML =
                    `ğŸ‰ <b>${data.customerName}</b> ê³ ê°ë‹˜ì˜ ìƒì¼ì´ ê°€ì¥ ê°€ê¹Œì›Œìš”! <br>
                     ğŸ“ ì£¼ì†Œ: ${data.address} <br>
                     ğŸ‚ ìƒì¼: ${data.birthDate} <br>
                     â³ D-Day: <b>${data.dday}ì¼ ë‚¨ìŒ</b>`;
            })
            .catch(err => console.error(err));
    });
</script>
</body>
</html>
