<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê³„ì¢Œ & ì¹´ë“œ ê´€ë¦¬</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; }
    h2 { color: #333; }
    label { display: block; margin-top: 12px; font-weight: bold; }
    input, select, button { padding: 8px; margin-top: 4px; }
    button { cursor: pointer; }
    .section { margin-bottom: 40px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #eee; }
    .success { color: green; font-weight: bold; margin-bottom: 6px; }
    .error { color: red; font-weight: bold; margin-bottom: 6px; }
  </style>
</head>
<body>

<!-- ê³„ì¢Œ ìƒì„± -->
<div class="section">
  <h2>ìƒˆ ê³„ì¢Œ ë§Œë“¤ê¸°</h2>
  <form id="accountForm">
    <label>ê³ ê° ì´ë¦„ :</label>
    <input type="text" id="customerName" required>

    <label>ê³ ê° ì£¼ë¯¼ë²ˆí˜¸(SSN) :</label>
    <input type="text" id="customerSsn" required>

    <label>ê³„ì¢Œ ì¢…ë¥˜ :</label>
    <select id="accountType">
      <option value="ì ê¸ˆ">ì ê¸ˆ</option>
      <option value="ì…ì¶œê¸ˆ">ì…ì¶œê¸ˆ</option>
    </select><br><br>

    <button type="button" onclick="submitAccountForm()">ê³„ì¢Œ ìƒì„±</button>
  </form>
  <div id="accountResult"></div>
</div>

<hr>

<!-- ê³ ê° ê³„ì¢Œ ì¡°íšŒ -->
<div class="section">
  <h2>ê³ ê° ê³„ì¢Œ ì¡°íšŒ</h2>
  <label>ê³ ê° ì´ë¦„:</label>
  <input type="text" id="searchName" placeholder="í™ê¸¸ë™">
  <button onclick="fetchAccounts()">ì¡°íšŒ</button>
  <div id="accountsTable"></div>
</div>

<hr>

<!-- ì¹´ë“œ ë°œê¸‰ -->
<div class="section">
  <h2>ì¹´ë“œ ë°œê¸‰</h2>
  <form id="cardForm">
    <label>ê³ ê° SSN:</label>
    <input type="text" id="cardCustomerSsn" required>

    <label>ê³ ê° ì´ë¦„:</label>
    <input type="text" id="cardCustomerName" required>

    <label>ì—°ê²° ê³„ì¢Œ ID:</label>
    <input type="text" id="accountId" required>

    <label>ì¹´ë“œ ì¢…ë¥˜:</label>
    <select id="cardType">
      <option value="ì‹ ìš©">ì‹ ìš©ì¹´ë“œ</option>
      <option value="ì²´í¬">ì²´í¬ì¹´ë“œ</option>
    </select>

    <button type="button" onclick="issueCard()">ì¹´ë“œ ë°œê¸‰</button>
  </form>
  <div id="cardResult"></div>
</div>

<hr>

<!-- ê°€ì¥ ê°€ê¹Œìš´ ìƒì¼ ê³ ê° -->
<button id="btnNextBirthday">ê°€ì¥ ê°€ê¹Œìš´ ìƒì¼ ê³ ê° ì¡°íšŒ</button>
<div id="birthdayResult" style="margin-top:15px; font-size:18px; font-weight:bold;"></div>

<hr>

<div class="section">
  <h2>ê±°ë˜ ë“±ë¡</h2>
  <label>ê³ ê° ì´ë¦„:</label>
  <input type="text" id="transCustomerName" placeholder="í™ê¸¸ë™">
  <label>ê³ ê° SSN:</label>
  <input type="text" id="transCustomerSsn" placeholder="010507-11111111">
  <label>ê³„ì¢Œ ID:</label>
  <input type="text" id="transAccountId" placeholder="21">
  <label>ê¸ˆì•¡:</label>
  <input type="number" id="transAmount" placeholder="10000">
  <label>ê±°ë˜ ë‚´ìš©:</label>
  <input type="text" id="transContent" placeholder="ì¹´í˜, í¸ì˜ì  ë“±">
  <label>ê±°ë˜ íƒ€ì…:</label>
  <select id="transType">
    <option value="ì…ê¸ˆ">ì…ê¸ˆ</option>
    <option value="ì¶œê¸ˆ">ì¶œê¸ˆ</option>
  </select>
  <button onclick="createTransaction()">ê±°ë˜ ë“±ë¡</button>
  <div id="transactionCreateResult"></div>
</div>

<div class="section">
  <h2>ê±°ë˜ ë‚´ì—­ ì¡°íšŒ (ì§€ë‚œ 1ê°œì›”)</h2>
  <label>ê³ ê° ì´ë¦„:</label>
  <input type="text" id="transSearchName" placeholder="í™ê¸¸ë™">
  <label>ê³ ê° SSN:</label>
  <input type="text" id="transSearchSsn" placeholder="010507-11111111">
  <button onclick="fetchTransactions()">ì¡°íšŒ</button>
  <div id="transactionResult"></div>
</div>


<script>
function submitAccountForm() {
    const name = document.getElementById("customerName").value;
    const ssn = document.getElementById("customerSsn").value;
    const type = document.getElementById("accountType").value;

    fetch(`/account/create?customerSsn=${ssn}&customerName=${name}&accountType=${type}`, {
        method: "POST"
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("accountResult").innerHTML =
            `<div class="success">ê³„ì¢Œ ìƒì„± ì™„ë£Œ!</div>
             <p>ê³„ì¢Œ ID: ${data.accountId}</p>
             <p>ê³„ì¢Œ ì¢…ë¥˜: ${data.accountType}</p>
             <p>ê³ ê° ì´ë¦„: ${data.customer.customerName}</p>
             <p>ê³ ê° SSN: ${data.customer.customerSsn}</p>`;
    })
    .catch(err => { alert("ì˜¤ë¥˜ ë°œìƒ: " + err); });
}

async function fetchAccounts() {
    const name = document.getElementById("searchName").value.trim();
    if (!name) return alert("ê³ ê° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

    try {
        const res = await fetch(`/account/by-name/grouped?customerName=${encodeURIComponent(name)}`);
        if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
        const grouped = await res.json();

        let html = "";
        for (const ssn in grouped) {
            html += `<h3>ê³ ê° SSN: ${ssn} (${grouped[ssn][0].customerName})</h3>`;
            html += `<table>
                        <tr><th>ê³„ì¢Œ ID</th><th>ê³„ì¢Œ ì¢…ë¥˜</th><th>ì”ì•¡</th></tr>`;
            grouped[ssn].forEach(acc => {
                html += `<tr>
                            <td>${acc.accountId}</td>
                            <td>${acc.accountType}</td>
                            <td>${acc.balance.toLocaleString()}ì›</td>
                         </tr>`;
            });
            html += `</table><br>`;
        }
        document.getElementById("accountsTable").innerHTML = html;
    } catch(err) {
        document.getElementById("accountsTable").innerHTML = `<div class="error">ì˜¤ë¥˜: ${err.message}</div>`;
    }
}

function issueCard() {
    const formData = new URLSearchParams();
    formData.append("customerSsn", document.getElementById("cardCustomerSsn").value);
    formData.append("customerName", document.getElementById("cardCustomerName").value);
    formData.append("accountId", document.getElementById("accountId").value);
    formData.append("cardType", document.getElementById("cardType").value);

    fetch("/account/card/issue", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formData.toString()
    })
    .then(res => res.json())
    .then(card => {
        document.getElementById("cardResult").innerHTML =
            `<div class="success">ì¹´ë“œ ë°œê¸‰ ì„±ê³µ!</div>
             <p>ì¹´ë“œ ID: ${card.cardId}</p>
             <p>ê³ ê° ì´ë¦„: ${card.customer.customerName}</p>
             <p>ê³ ê° SSN: ${card.customer.customerSsn}</p>
             <p>ì—°ê²° ê³„ì¢Œ ID: ${card.account.accountId}</p>
             <p>ì¹´ë“œ ì¢…ë¥˜: ${card.cardType}</p>
             <p>ë°œê¸‰ì¼: ${card.issueDate}</p>`;
    })
    .catch(err => {
        document.getElementById("cardResult").innerHTML = `<div class="error">${err}</div>`;
    });
}

document.getElementById("btnNextBirthday").addEventListener("click", function() {
    fetch("/account/next-birthday")
        .then(response => response.json())
        .then(data => {
            let resultArea = document.getElementById("birthdayResult");

            if(!data || !data.customerName) {
                resultArea.innerHTML = "ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }

            resultArea.innerHTML =
                `ğŸ‰ <b>${data.customerName}</b> ê³ ê°ë‹˜ì˜ ìƒì¼ì´ ê°€ì¥ ê°€ê¹Œì›Œìš”! <br>
                 ğŸ“ ì£¼ì†Œ: ${data.address} <br>
                 ğŸ‚ ìƒì¼: ${data.birthDate} <br>
                 â³ D-Day: <b>${data.dday}ì¼ ë‚¨ìŒ</b>`;
        })
        .catch(err => console.error(err));
});

async function createTransaction() {
    const accountId = Number(document.getElementById("transAccountId").value);
    const name = document.getElementById("transCustomerName").value.trim();
    const ssn = document.getElementById("transCustomerSsn").value.trim();
    const amount = Number(document.getElementById("transAmount").value);
    const type = document.getElementById("transType").value;
    const content = document.getElementById("transContent").value.trim();

    if (!content) return alert("ê±°ë˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");

    const formData = new URLSearchParams();
    formData.append("accountId", accountId);
    formData.append("type", type);
    formData.append("content", content);
    formData.append("amount", amount);

    try {
        const res = await fetch("/account/transaction/create", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: formData.toString()
        });

        if (!res.ok) throw new Error("ê±°ë˜ ë“±ë¡ ì‹¤íŒ¨");

        const data = await res.json();
        document.getElementById("transactionCreateResult").innerHTML =
            `<div class="success">${data.transactionType} ì™„ë£Œ! ì”ì•¡: ${Number(data.balanceAfter).toLocaleString()}ì›</div>`;
    } catch (err) {
        document.getElementById("transactionCreateResult").innerHTML = `<div class="error">${err.message}</div>`;
    }
}

async function fetchTransactions() {
    const name = document.getElementById("transSearchName").value.trim();
    const ssn = document.getElementById("transSearchSsn").value.trim();

    if (!name || !ssn) {
        alert("ê³ ê° ì´ë¦„ê³¼ SSNì„ ì…ë ¥í•˜ì„¸ìš”");
        return;
    }

    try {
        const res = await fetch(`/account/transactions/by-customer?customerName=${encodeURIComponent(name)}&customerSsn=${encodeURIComponent(ssn)}`);
        const list = await res.json();

        if (list.length === 0) {
            document.getElementById("transactionResult").innerHTML = "<div class='error'>ê±°ë˜ ë‚´ì—­ ì—†ìŒ</div>";
            return;
        }
let html = `<table>
                <tr>
                    <th>ì¼ì</th>
                    <th>êµ¬ë¶„</th>
                    <th>ê¸ˆì•¡</th>
                    <th>ì”ì•¡</th>
                    <th>ê±°ë˜ ë‚´ì—­</th> <!-- ìƒˆ ì»¬ëŸ¼ -->
                </tr>`;
list.forEach(t => {
    html += `<tr>
                <td>${t.transactionDate}</td>
                <td>${t.transactionType}</td>
                <td>${Number(t.amount).toLocaleString()}ì›</td>
                <td>${Number(t.balanceAfter).toLocaleString()}ì›</td>
                <td>${t.transactionContent}</td> <!-- ê±°ë˜ ë‚´ì—­ í‘œì‹œ -->
             </tr>`;
});

        html += `</table>`;
        document.getElementById("transactionResult").innerHTML = html;
    } catch (err) {
        document.getElementById("transactionResult").innerHTML = `<div class="error">${err.message}</div>`;
    }
}

</script>
</body>
</html>
