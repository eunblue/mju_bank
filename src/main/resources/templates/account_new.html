<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ëª…ì§€ì€í–‰ - ê³„ì¢Œ & ì¹´ë“œ ê´€ë¦¬</title>
  <style>
/* ê¸°ë³¸ ì„¤ì • */
body {
    font-family: 'Malgun Gothic', Arial, sans-serif;
    background-color: #f4f7f6;
    margin: 0;
    padding: 0;
    color: #333;
}
.container {
    max-width: 1000px;
    margin: auto;
    padding: 20px;
}

/* í—¤ë” */
#header {
    background-color: #004d99;
    color: white;
    display: flex;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 5px solid #002c5f;
}
#bankLogo {
    height: 50px;
    margin-right: 15px;
}
#bankName {
    font-size: 26px;
    font-weight: bold;
}

/* ì„¹ì…˜ ì¹´ë“œ */
.section {
    background-color: #fff;
    padding: 25px 30px;
    margin-bottom: 30px;
    border-radius: 10px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.05);
}
h2 {
    color: #004d99;
    font-size: 22px;
    margin-bottom: 20px;
    border-left: 5px solid #004d99;
    padding-left: 12px;
}

/* ë¼ë²¨ & ì…ë ¥ */
label {
    display: block;
    font-weight: bold;
    margin-top: 15px;
    color: #555;
}
input, select {
    width: 100%;
    padding: 10px 12px;
    margin-top: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 16px;
    box-sizing: border-box;
}
input:focus, select:focus {
    border-color: #004d99;
    outline: none;
}

/* ë²„íŠ¼ */
button {
    cursor: pointer;
    background-color: #0099cc;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    margin-top: 15px;
    font-weight: bold;
    transition: all 0.3s ease;
}
button:hover {
    background-color: #007399;
}

/* ì¡°íšŒ ë²„íŠ¼ ë³„ë„ ìŠ¤íƒ€ì¼ */
#searchName + button {
    width: auto;
    margin-left: 10px;
    padding: 10px 18px;
    background-color: #28a745;
}
#searchName + button:hover {
    background-color: #1e7e34;
}

/* í…Œì´ë¸” */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 18px;
}
th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
}
th {
    background: linear-gradient(90deg, #004d99, #0077cc);
    color: white;
    font-weight: normal;
}
tr:hover {
    background-color: #f1f9ff;
}

/* ê²°ê³¼ ë©”ì‹œì§€ */
.success {
    color: #28a745;
    font-weight: bold;
    margin-top: 12px;
    padding: 10px;
    background-color: #e2f7e4;
    border-radius: 6px;
}
.error {
    color: #dc3545;
    font-weight: bold;
    margin-top: 12px;
    padding: 10px;
    background-color: #f9e2e5;
    border-radius: 6px;
}

/* ìƒì¼ ì¡°íšŒ */
#birthdayResult {
    padding: 15px;
    background-color: #fffbe6;
    border: 1px solid #ffc107;
    border-radius: 6px;
    line-height: 1.6;
    font-size: 17px;
    margin-top: 10px;
}

/* ë°˜ì‘í˜• */
@media (max-width: 600px) {
    #header { flex-direction: column; align-items: flex-start; }
    #bankName { margin-top: 8px; }
    input, select, button { width: 100%; }
    #searchName + button { margin-left: 0; margin-top: 10px; }
}
</style>
</head>
<body>
<div id="header">
  <img src="/images/symbol02.png" alt="ì‹¬ë³¼">
  <span id="bankName">ëª…ì§€ì€í–‰ - ê¸ˆìœµ ì„œë¹„ìŠ¤</span>
</div>

<div class="container">
  <!-- ê³„ì¢Œ ìƒì„± -->
  <div class="section">
    <h2>ìƒˆ ê³„ì¢Œ ë§Œë“¤ê¸° ğŸ¦</h2>
    <form id="accountForm">
      <label>ê³ ê° ì´ë¦„ :</label>
      <input type="text" id="customerName" required placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.">
      <label>ê³ ê° ì£¼ë¯¼ë²ˆí˜¸(SSN) :</label>
      <input type="text" id="customerSsn" required placeholder="ex)991122-1234567">

      <label>ê³„ì¢Œ ì¢…ë¥˜ :</label>
      <select id="accountType">
        <option value="ì ê¸ˆ">ì…ì¶œê¸ˆ</option>
        <option value="ì…ì¶œê¸ˆ">ì ê¸ˆ</option>
      </select>

      <button type="button" onclick="submitAccountForm()">ê³„ì¢Œ ìƒì„±</button>
    </form>
    <div id="accountResult"></div>
  </div>

  <!-- ê³ ê° ê³„ì¢Œ ì¡°íšŒ -->
  <div class="section">
    <h2>ê³ ê° ê³„ì¢Œ ì¡°íšŒ ğŸ”</h2>
    <label>ê³ ê° ì´ë¦„:</label>
    <input type="text" id="searchName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.">
    <button onclick="fetchAccounts()">ì¡°íšŒ</button>
    <div id="accountsTable"></div>
  </div>

  <!-- ì¹´ë“œ ë°œê¸‰ -->
  <div class="section">
    <h2>ì¹´ë“œ ë°œê¸‰ ğŸ’³</h2>
    <form id="cardForm">
      <label>ê³ ê° SSN:</label>
      <input type="text" id="cardCustomerSsn" required placeholder="ex)991122-1234567">

      <label>ê³ ê° ì´ë¦„:</label>
      <input type="text" id="cardCustomerName" required placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.">

      <label>ì—°ê²° ê³„ì¢Œ ID:</label>
      <input type="text" id="accountId" required placeholder="ê³„ì¢Œë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">

      <label>ì¹´ë“œ ì¢…ë¥˜:</label>
      <select id="cardType">
        <option value="ì‹ ìš©">ì‹ ìš©ì¹´ë“œ</option>
        <option value="ì²´í¬">ì²´í¬ì¹´ë“œ</option>
      </select>

      <button type="button" onclick="issueCard()">ì¹´ë“œ ë°œê¸‰ ì‹ ì²­</button>
    </form>
    <div id="cardResult"></div>
  </div>

  <!-- ê°€ì¥ ê°€ê¹Œìš´ ìƒì¼ -->
  <button id="btnNextBirthday">ê°€ì¥ ê°€ê¹Œìš´ ìƒì¼ ê³ ê° ì¡°íšŒ ğŸ‚</button>
  <div id="birthdayResult"></div>

  <!-- ê±°ë˜ ë“±ë¡ -->
  <div class="section">
    <h2>ê±°ë˜ ë“±ë¡</h2>
    <label>ê³ ê° ì´ë¦„:</label>
    <input type="text" id="transCustomerName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.">
    <label>ê³ ê° SSN:</label>
    <input type="text" id="transCustomerSsn" placeholder="ex)991122-1234567">
    <label>ê³„ì¢Œ ID:</label>
    <input type="text" id="transAccountId" placeholder="ê³„ì¢Œë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
    <label>ê¸ˆì•¡:</label>
    <input type="number" id="transAmount" placeholder="ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.">
    <label>ê±°ë˜ ë‚´ìš©:</label>
    <input type="text" id="transContent" placeholder="ì¹´í˜, í¸ì˜ì  ë“±">
    <label>ê±°ë˜ íƒ€ì…:</label>
    <select id="transType">
      <option value="ì…ê¸ˆ">ì…ê¸ˆ</option>
      <option value="ì¶œê¸ˆ">ì¶œê¸ˆ</option>
    </select>
    <button onclick="createTransaction()">ê±°ë˜ ë“±ë¡</button>
    <div id="transactionCreateResult"></div>
  </div>

  <!-- ê±°ë˜ ë‚´ì—­ ì¡°íšŒ -->
  <div class="section">
    <h2>ê±°ë˜ ë‚´ì—­ ì¡°íšŒ (ì§€ë‚œ 1ê°œì›”)</h2>
    <label>ê³ ê° ì´ë¦„:</label>
    <input type="text" id="transSearchName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.">
    <label>ê³ ê° SSN:</label>
    <input type="text" id="transSearchSsn" placeholder="ex)991122-1234567">
    <button onclick="fetchTransactions()">ì¡°íšŒ</button>
    <div id="transactionResult"></div>
  </div>

  <!-- ì¹´ë“œ&ê³„ì¢Œ&ì‚¬ìš©ë‚´ì—­ ì¡°íšŒ -->
  <div class="section">
    <h2>ê³ ê° ì¹´ë“œ & ê³„ì¢Œ & ì‚¬ìš©ë‚´ì—­ ì¡°íšŒ</h2>
    <label>ê³ ê° ì´ë¦„:</label>
    <input type="text" id="cardInfoName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.">
    <label>ê³ ê° SSN:</label>
    <input type="text" id="cardInfoSsn" placeholder="ex)991122-123456">
    <button onclick="fetchCardUsage()">ì¡°íšŒ</button>
    <div id="cardUsageResult"></div>
  </div>
</div>

<script>
function submitAccountForm() {
    const name = document.getElementById("customerName").value;
    const ssn = document.getElementById("customerSsn").value;
    const type = document.getElementById("accountType").value;

    fetch(`/account/create?customerSsn=${ssn}&customerName=${name}&accountType=${type}`, {
        method: "POST"
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("accountResult").innerHTML =
            `<div class="success">ê³„ì¢Œ ìƒì„± ì™„ë£Œ!</div>
             <p>ê³„ì¢Œ ID: ${data.accountId}</p>
             <p>ê³„ì¢Œ ì¢…ë¥˜: ${data.accountType}</p>
             <p>ê³ ê° ì´ë¦„: ${data.customer.customerName}</p>
             <p>ê³ ê° SSN: ${data.customer.customerSsn}</p>`;
    })
    .catch(err => { alert("ì˜¤ë¥˜ ë°œìƒ: " + err); });
}

async function fetchAccounts() {
    const name = document.getElementById("searchName").value.trim();
    if (!name) return alert("ê³ ê° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

    try {
        const res = await fetch(`/account/by-name/grouped?customerName=${encodeURIComponent(name)}`);
        if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
        const grouped = await res.json();

        let html = "";
        for (const ssn in grouped) {
            html += `<h3>ê³ ê° SSN: ${ssn} (${grouped[ssn][0].customerName})</h3>`;
            html += `<table>
                        <tr><th>ê³„ì¢Œ ID</th><th>ê³„ì¢Œ ì¢…ë¥˜</th><th>ì”ì•¡</th></tr>`;
            grouped[ssn].forEach(acc => {
                const balance = acc.balance ?? 0;
                html += `<tr>
                            <td>${acc.accountId}</td>
                            <td>${acc.accountType}</td>
                            <td>${Number(balance).toLocaleString()}ì›</td>
                         </tr>`;
            });
            html += `</table><br>`;
        }
        document.getElementById("accountsTable").innerHTML = html;
    } catch(err) {
        document.getElementById("accountsTable").innerHTML = `<div class="error">ì˜¤ë¥˜: ${err.message}</div>`;
    }
}

function issueCard() {
    const formData = new URLSearchParams();
    formData.append("customerSsn", document.getElementById("cardCustomerSsn").value);
    formData.append("customerName", document.getElementById("cardCustomerName").value);
    formData.append("accountId", document.getElementById("accountId").value);
    formData.append("cardType", document.getElementById("cardType").value);

    fetch("/account/card/issue", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formData.toString()
    })
    .then(res => res.json())
    .then(card => {
        document.getElementById("cardResult").innerHTML =
        `<div class="success">ì¹´ë“œ ë°œê¸‰ ì„±ê³µ!</div>
         <p><b>ì¹´ë“œ ID:</b> ${card.cardId}</p>
         <p><b>ì¹´ë“œ ì¢…ë¥˜:</b> ${card.cardType}</p>
         <p><b>ì—°ê²° ê³„ì¢Œ ID:</b> ${card.accountId ?? '-'}</p>
         <p><b>ê³„ì¢Œ ì”ì•¡:</b> ${Number(card.accountBalance ?? 0).toLocaleString()}ì›</p>
         <p><b>ì‚¬ìš© í•œë„:</b> ${Number(card.limitAmount ?? 0).toLocaleString()}ì›</p>`;
    })
    .catch(err => {
        document.getElementById("cardResult").innerHTML = `<div class="error">${err}</div>`;
    });
}


document.getElementById("btnNextBirthday").addEventListener("click", function() {
    fetch("/account/next-birthday")
        .then(response => response.json())
        .then(data => {
            let resultArea = document.getElementById("birthdayResult");
            if(!data || !data.customerName) {
                resultArea.innerHTML = "ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }
            resultArea.innerHTML =
                `ğŸ‰ <b>${data.customerName}</b> ê³ ê°ë‹˜ì˜ ìƒì¼ì´ ê°€ì¥ ê°€ê¹Œì›Œìš”! <br>
                 ğŸ“ ì£¼ì†Œ: ${data.address} <br>
                 ğŸ‚ ìƒì¼: ${data.birthDate} <br>
                 â³ D-Day: <b>${data.dday}ì¼ ë‚¨ìŒ</b>`;
        })
        .catch(err => console.error(err));
});

async function createTransaction() {
    const accountId = Number(document.getElementById("transAccountId").value);
    const name = document.getElementById("transCustomerName").value.trim();
    const ssn = document.getElementById("transCustomerSsn").value.trim();
    const amount = Number(document.getElementById("transAmount").value);
    const type = document.getElementById("transType").value;
    const content = document.getElementById("transContent").value.trim();

    if (!content) return alert("ê±°ë˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");

    const formData = new URLSearchParams();
    formData.append("accountId", accountId);
    formData.append("type", type);
    formData.append("content", content);
    formData.append("amount", amount);

    try {
        const res = await fetch("/account/transaction/create", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: formData.toString()
        });

        if (!res.ok) throw new Error("ê±°ë˜ ë“±ë¡ ì‹¤íŒ¨");

        const data = await res.json();
        document.getElementById("transactionCreateResult").innerHTML =
            `<div class="success">${data.transactionType} ì™„ë£Œ! ì”ì•¡: ${Number(data.balanceAfter ?? 0).toLocaleString()}ì›</div>`;
    } catch (err) {
        document.getElementById("transactionCreateResult").innerHTML = `<div class="error">${err.message}</div>`;
    }
}

async function fetchTransactions() {
    const name = document.getElementById("transSearchName").value.trim();
    const ssn = document.getElementById("transSearchSsn").value.trim();

    if (!name || !ssn) {
        alert("ê³ ê° ì´ë¦„ê³¼ SSNì„ ì…ë ¥í•˜ì„¸ìš”");
        return;
    }

    try {
        const res = await fetch(`/account/transactions/by-customer?customerName=${encodeURIComponent(name)}&customerSsn=${encodeURIComponent(ssn)}`);
        const list = await res.json();

        if (list.length === 0) {
            document.getElementById("transactionResult").innerHTML = "<div class='error'>ê±°ë˜ ë‚´ì—­ ì—†ìŒ</div>";
            return;
        }

        let html = `<table>
                <tr>
                    <th>ì¼ì</th>
                    <th>êµ¬ë¶„</th>
                    <th>ê¸ˆì•¡</th>
                    <th>ì”ì•¡</th>
                    <th>ê±°ë˜ ë‚´ì—­</th>
                </tr>`;
        list.forEach(t => {
            html += `<tr>
                        <td>${t.transactionDate}</td>
                        <td>${t.transactionType}</td>
                        <td>${Number(t.amount ?? 0).toLocaleString()}ì›</td>
                        <td>${Number(t.balanceAfter ?? 0).toLocaleString()}ì›</td>
                        <td>${t.transactionContent ?? '-'}</td>
                     </tr>`;
        });

        html += `</table>`;
        document.getElementById("transactionResult").innerHTML = html;
    } catch (err) {
        document.getElementById("transactionResult").innerHTML = `<div class="error">${err.message}</div>`;
    }
}

async function fetchCardUsage() {
    const ssn = document.getElementById("cardInfoSsn").value.trim();

    if (!ssn) return alert("ê³ ê° SSNì„ ì…ë ¥í•˜ì„¸ìš”.");

    try {
        const res = await fetch(`/account/card-info/all?customerSsn=${encodeURIComponent(ssn)}`);
        if (!res.ok) throw new Error("ì¡°íšŒ ì‹¤íŒ¨");
        const cards = await res.json();

        if (cards.length === 0) {
            document.getElementById("cardUsageResult").innerHTML = "ì¡°íšŒ ê²°ê³¼ ì—†ìŒ";
            return;
        }

        let html = `<table>
            <tr>
              <th>ì¹´ë“œ ID</th>
              <th>ì¹´ë“œ ì¢…ë¥˜</th>
              <th>ì—°ê²° ê³„ì¢Œ ID</th>
              <th>í˜„ì¬ ì”ì•¡</th>
              <th>ì‚¬ìš© ê¸ˆì•¡</th>
              <th>ì‚¬ìš© í•œë„</th>
            </tr>`;

        cards.forEach(c => {
            html += `<tr>
                        <td>${c.cardId}</td>
                        <td>${c.cardType}</td>
                        <td>${c.accountId}</td>
                        <td>${Number(c.accountBalance ?? 0).toLocaleString()}ì›</td>
                        <td>${c.cardType === "ì‹ ìš©" ? Number(c.usedAmount ?? 0).toLocaleString() + "ì›" : "-"}</td>
                        <td>${c.cardType === "ì‹ ìš©" ? Number(c.limitAmount ?? 0).toLocaleString() + "ì›" : "-"}</td>
                     </tr>`;
        });

        html += `</table>`;
        document.getElementById("cardUsageResult").innerHTML = html;

    } catch (err) {
        document.getElementById("cardUsageResult").innerHTML = `<div class="error">${err.message}</div>`;
    }
}
</script>
</body>
</html>
